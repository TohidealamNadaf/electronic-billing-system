<ion-header class="ion-no-border">
    <ion-toolbar color="white" class="border-b border-slate-200">
        <ion-buttons slot="start">
            <ion-menu-button color="dark"></ion-menu-button>
        </ion-buttons>
        <div class="flex items-center gap-2">
            <ion-title class="font-display font-bold text-lg text-slate-900 px-0">
                {{ editEstimateId() ? 'Edit Estimate' : 'Estimate' }}
            </ion-title>
            <span
                class="px-2 py-0.5 rounded-full bg-primary-50 text-primary-700 text-[10px] font-bold uppercase tracking-wider border border-primary-200">
                {{ editEstimateId() ? 'Editing' : 'Draft' }}
            </span>
        </div>
        <ion-buttons slot="end" class="gap-0 pr-1">
            <ion-button (click)="printEstimate()" fill="clear" size="small" class="text-slate-600">
                <ion-icon slot="icon-only" name="print-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="saveEstimate()" color="primary" fill="solid" size="small" shape="round"
                class="font-bold text-xs shadow-sm h-7 min-h-0 ml-1">
                Save
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content class="bg-slate-50">
    <div class="max-w-7xl mx-auto space-y-4 animate-fade-in pb-20 no-print p-3">

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Left Column: Details & Items -->
            <div class="lg:col-span-3 space-y-4">

                <!-- General Info Card -->
                <div class="bg-white rounded border border-slate-200 p-4 shadow-sm">
                    <h3
                        class="font-display font-bold text-sm text-slate-800 mb-3 flex items-center gap-2 uppercase tracking-wide">
                        Customer Details
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1">Customer</label>
                            <ng-select #clientSelect [items]="clients()" bindLabel="name" bindValue="id"
                                [searchable]="true" [clearable]="true" placeholder="Select Client..." class="text-sm"
                                [ngModel]="selectedClientId()" (ngModelChange)="selectedClientId.set($event)"
                                (change)="clientSelect.blur()">
                            </ng-select>
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1">Date</label>
                            <input type="text" placeholder="Select Date"
                                class="w-full px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm font-medium text-slate-700 focus:ring-1 focus:ring-primary-500 focus:border-primary-500"
                                bsDatepicker
                                [bsConfig]="{ adaptivePosition: true, isAnimated: true, dateInputFormat: 'YYYY-MM-DD', containerClass: 'theme-default' }"
                                [ngModel]="estimateDate()" (ngModelChange)="estimateDate.set($event)">
                        </div>
                    </div>

                    <!-- Custom Client Fields Display -->
                    @if (selectedClient(); as client) {
                    <div class="mt-4 pt-3 border-t border-slate-100 flex flex-wrap gap-x-6 gap-y-2">
                        @if (client.email) {
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Email</span>
                            <span class="text-xs text-slate-600 font-medium">{{ client.email }}</span>
                        </div>
                        }
                        @if (client.phone) {
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Phone</span>
                            <span class="text-xs text-slate-600 font-medium">{{ client.phone }}</span>
                        </div>
                        }
                        @if (client.address) {
                        <div class="flex flex-col max-w-xs">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Address</span>
                            <span class="text-xs text-slate-600 font-medium truncate" title="{{client.address}}">{{
                                client.address }}</span>
                        </div>
                        }
                    </div>
                    }
                </div>

                <!-- Line Items Card -->
                <div
                    class="bg-white rounded border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[400px]">
                    <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-display font-bold text-sm text-slate-800 uppercase tracking-wide">
                            Line Items
                        </h3>
                        <div class="flex items-center gap-2">
                            <button (click)="addItem()"
                                class="text-[10px] font-bold uppercase tracking-wide text-primary-700 bg-primary-50 hover:bg-primary-100 px-2 py-1 rounded border border-primary-200 transition-colors shadow-sm">
                                + Add Item
                            </button>
                        </div>
                    </div>

                    <div class="overflow-y-auto p-2 custom-scrollbar" style="height: 385px;">
                        <table class="w-full text-left border-collapse relative">
                            <thead>
                                <tr
                                    class="bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase tracking-wide sticky top-0 z-10">
                                    <th *ngFor="let col of customColumns()" class="px-4 py-2 bg-slate-50"
                                        [class.text-center]="col.id === 'quantity'"
                                        [class.text-right]="col.id === 'price' || col.id === 'total' || (col.isBuiltIn === false && col.type !== 'text')"
                                        [class.text-left]="col.id === 'product' || (col.isBuiltIn === false && col.type === 'text')"
                                        [style.width]="col.id === 'product' ? (customColumns().length > 5 ? '30%' : 'auto') : '120px'">
                                        {{ col.isBuiltIn ? (columnLabels()[col.id] || col.id) : col.name }}
                                    </th>
                                    <th class="px-2 py-2 w-8 bg-slate-50"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                @for (item of items(); track $index) {
                                <tr class="group hover:bg-blue-50/30 transition-colors">
                                    <td *ngFor="let col of customColumns()" class="px-4 py-1.5 align-middle"
                                        [class.text-center]="col.id === 'quantity'"
                                        [class.text-right]="col.id === 'price' || col.id === 'total' || (col.isBuiltIn === false && col.type !== 'text')"
                                        [class.text-left]="col.id === 'product' || (col.isBuiltIn === false && col.type === 'text')">

                                        <ng-container [ngSwitch]="col.id">
                                            <!-- Built-in: Product -->
                                            <div *ngSwitchCase="'product'">
                                                @if (item.productId && item.productName) {
                                                <div class="flex items-center justify-between group/edit">
                                                    <div class="text-sm font-medium text-slate-900 cursor-pointer hover:text-primary-600 hover:underline"
                                                        (click)="openNameEdit($index, item.productName || '')"
                                                        title="Click to edit name">
                                                        {{ item.productName }}
                                                    </div>
                                                    <div class="flex gap-1 ml-2">
                                                        <button (click)="openNameEdit($index, item.productName || '')"
                                                            class="p-1 text-primary-600 hover:bg-primary-50 rounded"
                                                            title="Edit Name">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                                fill="currentColor" class="w-3.5 h-3.5">
                                                                <path
                                                                    d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" />
                                                            </svg>
                                                        </button>
                                                        <button (click)="resetItem($index)"
                                                            class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"
                                                            title="Change Product">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                                viewBox="0 0 24 24" stroke-width="2"
                                                                stroke="currentColor" class="w-3.5 h-3.5">
                                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                                    d="M6 18 18 6M6 6l12 12" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                } @else {
                                                <ng-select [items]="products()" bindLabel="name" [searchable]="true"
                                                    [addTag]="true" placeholder="Select Product..." appendTo="body"
                                                    class="text-sm min-w-[200px]" [ngModel]="item.productId"
                                                    (ngModelChange)="onProductChange($index, $event)">
                                                </ng-select>
                                                }
                                            </div>

                                            <!-- Built-in: Quantity -->
                                            <div *ngSwitchCase="'quantity'">
                                                <input type="number" [ngModel]="item.quantity"
                                                    (ngModelChange)="updateQuantity($index, $event)" min="1"
                                                    class="w-20 text-center bg-white border border-slate-200 rounded p-1 text-sm font-bold text-slate-800 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                            </div>

                                            <!-- Built-in: Price -->
                                            <div *ngSwitchCase="'price'">
                                                <div class="flex items-center justify-end gap-1">
                                                    <span class="text-slate-400 text-xs font-bold">₹</span>
                                                    <input type="number" [ngModel]="item.price"
                                                        (ngModelChange)="updatePrice($index, $event)" min="0"
                                                        class="w-24 text-right bg-white border border-slate-200 rounded p-1 text-sm font-bold text-slate-800 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                                </div>
                                            </div>

                                            <!-- Built-in: Total (Calc) -->
                                            <div *ngSwitchCase="'total'">
                                                <div class="text-sm font-bold text-slate-900">₹{{ item.total |
                                                    number:'1.2-2' }}</div>
                                            </div>

                                            <!-- Custom Field -->
                                            <div *ngSwitchDefault>
                                                <div class="text-sm text-slate-700 font-medium whitespace-nowrap">
                                                    @if (col.type === 'calculated') {
                                                    {{ col.isCurrency ? '₹' : '' }}{{ getCustomColumnValue(item, col) |
                                                    number:
                                                    (col.isCurrency ? '1.2-2' : '1.0-2') }}
                                                    } @else {
                                                    <div class="flex items-center gap-1"
                                                        [class.justify-end]="col.type !== 'text'">
                                                        <span *ngIf="col.isCurrency"
                                                            class="opacity-40 text-[10px] font-bold">₹</span>
                                                        <input [type]="col.type === 'number' ? 'number' : 'text'"
                                                            [(ngModel)]="item.customValues[col.name]"
                                                            class="w-full bg-transparent border-b border-dashed border-slate-200 focus:border-primary-400 outline-none transition-colors py-0.5 text-xs font-bold font-mono"
                                                            [class.text-right]="col.type !== 'text'"
                                                            [placeholder]="col.name">
                                                    </div>
                                                    }
                                                </div>
                                            </div>
                                        </ng-container>
                                    </td>
                                    <td class="px-2 py-1.5 text-center align-middle">
                                        <button (click)="removeItem($index)"
                                            class="text-slate-300 hover:text-red-600 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="w-3.5 h-3.5">
                                                <path fill-rule="evenodd"
                                                    d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                }
                                @if (items().length === 0) {
                                <tr>
                                    <td [attr.colspan]="customColumns().length + 1"
                                        class="py-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center">
                                            <div class="bg-slate-50 p-3 rounded-full mb-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                    stroke-width="1.5" stroke="currentColor" class="w-6 h-6 opacity-30">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                                </svg>
                                            </div>
                                            <p class="text-xs font-medium">No items available</p>
                                        </div>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
                        <div class="flex justify-end">
                            <div class="w-1/2 md:w-1/3 space-y-1">
                                <div *ngIf="settings()?.isGstEnabled"
                                    class="flex justify-between text-xs text-slate-500">
                                    <span>Subtotal</span>
                                    <span>₹{{ subTotal() | number:'1.2-2' }}</span>
                                </div>
                                <div *ngIf="settings()?.isDiscountEnabled"
                                    class="flex justify-between items-center text-xs text-red-500">
                                    <span>Discount</span>
                                    <div class="flex items-center gap-1">
                                        <span class="opacity-50">- ₹</span>
                                        <input type="number" [ngModel]="discountAmount()"
                                            (ngModelChange)="discountAmount.set($event)"
                                            class="w-20 text-right bg-transparent border-b border-dashed border-red-200 focus:border-red-400 outline-none transition-colors py-0.5"
                                            placeholder="0.00">
                                    </div>
                                </div>
                                <div *ngIf="settings()?.isGstEnabled"
                                    class="flex justify-between text-xs text-slate-500">
                                    <span>GST ({{ settings()?.gstRate }})</span>
                                    <span>₹{{ taxTotal() | number:'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-slate-200">
                                    <span class="text-sm font-bold text-slate-900">Total</span>
                                    <span class="text-base font-bold text-slate-900">₹{{ grandTotal() | number:'1.2-2'
                                        }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary & Actions -->
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-slate-900 text-white rounded p-4 shadow-lg relative overflow-hidden">
                    <h3 class="font-bold text-sm mb-4 relative z-10">Summary</h3>
                    <div class="space-y-3 relative z-10">
                        <div class="bg-white/5 p-3 rounded border border-white/10">
                            <div class="text-slate-400 text-[10px] uppercase font-bold mb-1">Items</div>
                            <div class="text-lg font-bold">{{ items().length }}</div>
                        </div>

                        <div class="bg-primary-600 p-3 rounded border border-primary-500 shadow">
                            <div class="text-primary-100 text-[10px] uppercase font-bold mb-1">Grand Total</div>
                            <div class="text-xl font-bold text-white">₹{{ grandTotal() | number:'1.2-2' }}</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Custom Name Edit Modal -->
    @if (editNameState().isOpen) {
    <div
        class="fixed inset-0 bg-slate-900/50 z-[200] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden" (click)="$event.stopPropagation()">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-display font-bold text-lg text-slate-900">Customize Product Name</h3>
                <p class="text-xs text-slate-500 mt-1">Press Enter to save, Escape to cancel</p>
            </div>
            <div class="p-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Item Name</label>
                </div>
                <input #nameInput type="text" [ngModel]="editNameState().name"
                    (ngModelChange)="updateCustomName($event)" (keydown.enter)="saveCustomName()"
                    (keydown.escape)="closeNameEdit()"
                    class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-900 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
                <button (click)="closeNameEdit()"
                    class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wide rounded hover:bg-slate-50 transition-colors">
                    Cancel
                </button>
                <button (click)="saveCustomName()"
                    class="px-4 py-2 bg-primary-600 text-white text-xs font-bold uppercase tracking-wide rounded hover:bg-primary-700 transition-colors shadow-sm">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    }

</ion-content>