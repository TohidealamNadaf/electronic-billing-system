<ion-header class="ion-no-border">
    <ion-toolbar color="white" class="border-b border-slate-200">
        <ion-buttons slot="start">
            <ion-menu-button color="dark"></ion-menu-button>
        </ion-buttons>
        <div class="flex items-center gap-1.5 overflow-hidden">
            <ion-title class="font-display font-bold text-base text-slate-900 px-0 pl-2 shrink-0">Invoice</ion-title>
            <span *ngIf="editInvoiceId()"
                class="px-1.5 py-0.5 rounded bg-amber-50 text-amber-700 text-[9px] font-bold border border-amber-200 shrink-0">EDIT</span>
        </div>
        <ion-buttons slot="end" class="gap-0 pr-0.5">
            <ion-button (click)="printInvoice()" fill="clear" size="small" class="text-slate-600 w-8 h-8">
                <ion-icon slot="icon-only" name="print-outline" class="text-lg"></ion-icon>
            </ion-button>
            <ion-button (click)="newInvoice()" fill="clear" size="small" class="text-slate-600 w-8 h-8">
                <ion-icon slot="icon-only" name="add-circle-outline" class="text-lg"></ion-icon>
            </ion-button>
            <ion-button (click)="saveInvoice()" color="primary" fill="solid" size="small" shape="round"
                class="font-bold text-xs shadow-sm h-7 min-h-0 ml-1 px-3">
                Save
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content class="bg-slate-50">
    <div class="max-w-7xl mx-auto space-y-4 animate-fade-in pb-20 no-print p-3">

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Left Column: Details & Items -->
            <div class="lg:col-span-3 space-y-4">

                <!-- General Info Card -->
                <div class="bg-white rounded border border-slate-200 p-4 shadow-sm">
                    <h3
                        class="font-display font-bold text-sm text-slate-800 mb-3 flex items-center gap-2 uppercase tracking-wide">
                        Customer Details
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1">Customer</label>
                            <ng-select #clientSelect [items]="clients()" bindLabel="name" bindValue="id"
                                [searchable]="true" [clearable]="true" placeholder="Select Client..." class="text-sm"
                                [ngModel]="selectedClientId()" (ngModelChange)="selectedClientId.set($event)"
                                (change)="clientSelect.blur()">
                            </ng-select>
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1">Date</label>
                            <input type="text" placeholder="Select Date"
                                class="w-full px-2 py-1.5 bg-slate-50 border border-slate-200 rounded text-sm font-medium text-slate-700 focus:ring-1 focus:ring-primary-500 focus:border-primary-500"
                                bsDatepicker
                                [bsConfig]="{ adaptivePosition: true, isAnimated: true, dateInputFormat: 'YYYY-MM-DD', containerClass: 'theme-default' }"
                                [ngModel]="invoiceDate()" (ngModelChange)="invoiceDate.set($event)">
                        </div>
                    </div>

                    <!-- Custom Client Fields Display -->
                    @if (selectedClient(); as client) {
                    <div class="mt-4 pt-3 border-t border-slate-100 flex flex-wrap gap-x-6 gap-y-2">
                        @if (client.email) {
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Email</span>
                            <span class="text-xs text-slate-600 font-medium">{{ client.email }}</span>
                        </div>
                        }
                        @if (client.phone) {
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Phone</span>
                            <span class="text-xs text-slate-600 font-medium">{{ client.phone }}</span>
                        </div>
                        }
                        @if (client.address) {
                        <div class="flex flex-col max-w-xs">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Address</span>
                            <span class="text-xs text-slate-600 font-medium truncate" title="{{client.address}}">{{
                                client.address }}</span>
                        </div>
                        }
                        @for (cf of getParsedCustomFields(client.customFields); track cf.key) {
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">{{ cf.key }}</span>
                            <span class="text-xs text-slate-900 font-bold border-b border-primary-100">{{ cf.value
                                }}</span>
                        </div>
                        }
                    </div>
                    }
                </div>

                <!-- Line Items Card -->
                <div
                    class="bg-white rounded border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[400px]">
                    <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-display font-bold text-sm text-slate-800 uppercase tracking-wide">
                            Line Items
                        </h3>
                        <div class="flex items-center gap-2">
                            <button (click)="addItem()"
                                class="text-[10px] font-bold uppercase tracking-wide text-primary-700 bg-primary-50 hover:bg-primary-100 px-2 py-1 rounded border border-primary-200 transition-colors shadow-sm">
                                + Add Item
                            </button>
                        </div>
                    </div>

                    <div class="overflow-y-auto p-2 custom-scrollbar" style="height: 385px;">
                        <table class="w-full text-left border-collapse relative">
                            <thead>
                                <tr
                                    class="bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase tracking-wide sticky top-0 z-10">
                                    <th *ngFor="let col of customColumns()" class="px-4 py-2 bg-slate-50"
                                        [class.text-center]="col.id === 'quantity'"
                                        [class.text-right]="col.id === 'price' || col.id === 'total' || (col.isBuiltIn === false && col.type !== 'text')"
                                        [class.text-left]="col.id === 'product' || (col.isBuiltIn === false && col.type === 'text')"
                                        [style.width]="col.id === 'product' ? (customColumns().length > 5 ? '30%' : 'auto') : '120px'">
                                        {{ col.isBuiltIn ? (columnLabels()[col.id] || col.id) : col.name }}
                                    </th>
                                    <th class="px-2 py-2 w-8 bg-slate-50"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                @for (item of items(); track $index) {
                                <tr class="group hover:bg-blue-50/30 transition-colors">
                                    <td *ngFor="let col of customColumns()" class="px-4 py-1.5 align-middle"
                                        [class.text-center]="col.id === 'quantity'"
                                        [class.text-right]="col.id === 'price' || col.id === 'total' || (col.isBuiltIn === false && col.type !== 'text')"
                                        [class.text-left]="col.id === 'product' || (col.isBuiltIn === false && col.type === 'text')">

                                        <ng-container [ngSwitch]="col.id">
                                            <!-- Built-in: Product -->
                                            <div *ngSwitchCase="'product'">
                                                @if (item.productId && item.productName) {
                                                <div class="flex items-center justify-between group/edit">
                                                    <div class="text-sm font-medium text-slate-900 cursor-pointer hover:text-primary-600 hover:underline"
                                                        (click)="openNameEdit($index, item.productName || '')"
                                                        title="Click to edit name">
                                                        {{ item.productName }}
                                                    </div>
                                                    <div class="flex gap-1 ml-2">
                                                        <button (click)="openNameEdit($index, item.productName || '')"
                                                            class="p-1 text-primary-600 hover:bg-primary-50 rounded"
                                                            title="Edit Name">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                                fill="currentColor" class="w-3.5 h-3.5">
                                                                <path
                                                                    d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" />
                                                            </svg>
                                                        </button>
                                                        <button (click)="resetItem($index)"
                                                            class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"
                                                            title="Change Product">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                                viewBox="0 0 24 24" stroke-width="2"
                                                                stroke="currentColor" class="w-3.5 h-3.5">
                                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                                    d="M6 18 18 6M6 6l12 12" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                } @else {
                                                <ng-select [items]="products()" bindLabel="name" [searchable]="true"
                                                    [addTag]="true" placeholder="Select Product..." appendTo="body"
                                                    class="text-sm min-w-[200px]"
                                                    [ngModel]="getProductSelection(item.productId)"
                                                    (ngModelChange)="onProductChange($index, $event)">
                                                    <ng-template ng-option-tmp let-item="item">
                                                        <div class="flex items-center justify-between w-full">
                                                            <div>{{item.name}}</div>
                                                            @if (item.stock < 5) { <span
                                                                class="text-xs font-bold px-1.5 py-0.5 rounded ml-2"
                                                                [class.text-red-600]="item.stock === 0"
                                                                [class.bg-red-50]="item.stock === 0"
                                                                [class.text-amber-600]="item.stock > 0"
                                                                [class.bg-amber-50]="item.stock > 0">
                                                                {{ item.stock === 0 ? 'Out of Stock' : 'Low: ' +
                                                                item.stock
                                                                }}
                                                                </span>
                                                                }
                                                        </div>
                                                        <div class="text-[10px] text-slate-400">{{item.description}}
                                                        </div>
                                                    </ng-template>
                                                </ng-select>
                                                }
                                            </div>

                                            <!-- Built-in: Quantity -->
                                            <div *ngSwitchCase="'quantity'">
                                                <input type="number" [ngModel]="item.quantity"
                                                    (ngModelChange)="updateQuantity($index, $event)" min="1"
                                                    class="w-20 text-center bg-white border border-slate-200 rounded p-1 text-sm font-bold text-slate-800 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                            </div>

                                            <!-- Built-in: Price -->
                                            <div *ngSwitchCase="'price'">
                                                <div class="flex items-center justify-end gap-1">
                                                    <span class="text-slate-400 text-xs font-bold">₹</span>
                                                    <input type="number" [ngModel]="item.price"
                                                        (ngModelChange)="updatePrice($index, $event)" min="0"
                                                        class="w-24 text-right bg-white border border-slate-200 rounded p-1 text-sm font-bold text-slate-800 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                                </div>
                                            </div>

                                            <!-- Built-in: Total (Calc) -->
                                            <div *ngSwitchCase="'total'">
                                                <div class="text-sm font-bold text-slate-900">₹{{ item.total |
                                                    number:'1.2-2' }}</div>
                                            </div>

                                            <!-- Custom Field -->
                                            <div *ngSwitchDefault>
                                                <div class="text-sm text-slate-700 font-medium whitespace-nowrap">
                                                    @if (col.type === 'calculated') {
                                                    {{ col.isCurrency ? '₹' : '' }}{{ getCustomColumnValue(item, col) |
                                                    number:
                                                    (col.isCurrency ? '1.2-2' : '1.0-2') }}
                                                    } @else {
                                                    <div class="flex items-center gap-1"
                                                        [class.justify-end]="col.type !== 'text'">
                                                        <span *ngIf="col.isCurrency"
                                                            class="opacity-40 text-[10px] font-bold">₹</span>
                                                        <input [type]="col.type === 'number' ? 'number' : 'text'"
                                                            [(ngModel)]="item.customValues[col.name]"
                                                            class="w-full bg-transparent border-b border-dashed border-slate-200 focus:border-primary-400 outline-none transition-colors py-0.5 text-xs font-bold font-mono"
                                                            [class.text-right]="col.type !== 'text'"
                                                            [placeholder]="col.name">
                                                    </div>
                                                    }
                                                </div>
                                            </div>
                                        </ng-container>
                                    </td>
                                    <td class="px-2 py-1.5 text-center align-middle">
                                        <button (click)="removeItem($index)"
                                            class="text-slate-300 hover:text-red-600 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="w-3.5 h-3.5">
                                                <path fill-rule="evenodd"
                                                    d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                }
                                @if (items().length === 0) {
                                <tr>
                                    <td [attr.colspan]="customColumns().length + 1"
                                        class="py-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center">
                                            <div class="bg-slate-50 p-3 rounded-full mb-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                    stroke-width="1.5" stroke="currentColor" class="w-6 h-6 opacity-30">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                                </svg>
                                            </div>
                                            <p class="text-xs font-medium">No items available</p>
                                        </div>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
                        <div class="flex justify-end">
                            <div class="w-1/2 md:w-1/3 space-y-1">
                                <div *ngIf="settings()?.isGstEnabled"
                                    class="flex justify-between text-xs text-slate-500">
                                    <span>Subtotal (Before Discount)</span>
                                    <span>₹{{ subTotal() | number:'1.2-2' }}</span>
                                </div>
                                <div *ngIf="settings()?.isDiscountEnabled"
                                    class="flex justify-between items-center text-xs text-red-500">
                                    <span>Discount</span>
                                    <div class="flex items-center gap-1">
                                        <span class="opacity-50">- ₹</span>
                                        <input type="number" [(ngModel)]="discountAmount"
                                            class="w-20 text-right bg-transparent border-b border-dashed border-red-200 focus:border-red-400 outline-none transition-colors py-0.5"
                                            placeholder="0.00">
                                    </div>
                                </div>
                                <div *ngIf="settings()?.isGstEnabled"
                                    class="flex justify-between text-xs text-slate-500">
                                    <span>GST ({{ settings()?.gstRate }})</span>
                                    <span>₹{{ taxTotal() | number:'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-slate-200">
                                    <span class="text-sm font-bold text-slate-900">Total</span>
                                    <span class="text-base font-bold text-slate-900">₹{{ grandTotal() | number:'1.2-2'
                                        }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary & Actions -->
            <div class="space-y-4">
                <!-- Summary Card -->
                <div class="bg-slate-900 text-white rounded p-4 shadow-lg relative overflow-hidden">
                    <h3 class="font-bold text-sm mb-4 relative z-10">Summary</h3>
                    <div class="space-y-3 relative z-10">
                        <div class="bg-white/5 p-3 rounded border border-white/10">
                            <div class="text-slate-400 text-[10px] uppercase font-bold mb-1">Items</div>
                            <div class="text-lg font-bold">{{ items().length }}</div>
                        </div>
                        <div class="bg-white/5 p-4 rounded border border-white/10 grid grid-cols-2 gap-4">
                            <div class="overflow-hidden">
                                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2">Advanced Paid</div>
                                <div class="text-base font-bold text-green-400 break-all">₹{{ paidAmount() |
                                    number:'1.2-2'
                                    }}</div>
                            </div>
                            <div class="overflow-hidden">
                                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2">Remaining</div>
                                <div class="text-base font-bold text-amber-400 break-all">₹{{ balanceAmount() |
                                    number:'1.2-2' }}</div>
                            </div>
                        </div>
                        <div class="bg-primary-600 p-3 rounded border border-primary-500 shadow">
                            <div class="text-primary-100 text-[10px] uppercase font-bold mb-1">Grand Total</div>
                            <div class="text-xl font-bold text-white">₹{{ grandTotal() | number:'1.2-2' }}</div>
                        </div>
                    </div>
                </div>

                <!-- Payment & Options Card -->
                <div class="bg-white rounded border border-slate-200 shadow-sm overflow-hidden">
                    <div class="px-4 py-2 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 text-[10px] uppercase tracking-wider">Payment Details</h3>
                        <label class="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" [ngModel]="isInstallmentMode()"
                                (ngModelChange)="isInstallmentMode.set($event)"
                                class="w-3 h-3 rounded text-primary-600 border-slate-300">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Enable Installments</span>
                        </label>
                    </div>

                    <!-- Installment Mode: Payment History Table -->
                    <div class="p-4 space-y-4" *ngIf="isInstallmentMode()">
                        <div class="space-y-2">
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Payment History</label>
                                <button (click)="addPayment()"
                                    class="text-[9px] font-bold uppercase tracking-wide text-primary-700 bg-primary-50 px-2 py-0.5 rounded border border-primary-200 hover:bg-primary-100">
                                    + Add Payment
                                </button>
                            </div>

                            <div class="bg-slate-50 border border-slate-200 rounded overflow-hidden">
                                <table class="w-full text-left text-xs">
                                    <thead class="bg-slate-100 border-b border-slate-200">
                                        <tr>
                                            <th class="px-3 py-2 font-semibold text-slate-600" style="width: 45%;">Date
                                            </th>
                                            <th class="px-3 py-2 font-semibold text-slate-600 text-right"
                                                style="width: 45%;">Amount</th>
                                            <th class="px-2 py-2" style="width: 10%;"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200">
                                        @for (pay of payments(); track $index) {
                                        <tr>
                                            <td class="px-3 py-1.5">
                                                <input type="text" bsDatepicker
                                                    [bsConfig]="{ adaptivePosition: true, isAnimated: true, dateInputFormat: 'YYYY-MM-DD', containerClass: 'theme-default' }"
                                                    [(ngModel)]="pay.date" (ngModelChange)="triggerPaymentUpdate()"
                                                    class="w-full bg-transparent border-b border-transparent focus:border-primary-400 outline-none p-0.5 text-slate-800 font-medium text-xs">
                                            </td>
                                            <td class="px-3 py-1.5">
                                                <input type="number" [(ngModel)]="pay.amount"
                                                    (ngModelChange)="triggerPaymentUpdate()" placeholder="0.00"
                                                    class="w-full text-right bg-transparent border-b border-transparent focus:border-primary-400 outline-none p-0.5 text-slate-800 font-bold">
                                            </td>
                                            <td class="px-2 py-1.5 text-center">
                                                <button (click)="removePayment($index)"
                                                    class="text-slate-400 hover:text-red-500">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                        fill="currentColor" class="w-3.5 h-3.5">
                                                        <path
                                                            d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                        }
                                        @if (payments().length === 0) {
                                        <tr>
                                            <td colspan="3"
                                                class="px-2 py-3 text-center text-slate-400 italic font-medium">
                                                No payments recorded
                                            </td>
                                        </tr>
                                        }
                                    </tbody>
                                    <tfoot class="bg-slate-100 border-t border-slate-200">
                                        <tr>
                                            <td class="px-3 py-2 font-bold text-slate-600 text-right">Total Paid:</td>
                                            <td class="px-3 py-2 font-bold text-green-700 text-right">₹{{ paidAmount() |
                                                number:'1.2-2' }}</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-100">
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Balance Due</div>
                                <div class="text-base font-bold text-slate-900">₹{{ balanceAmount() | number:'1.2-2' }}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Status</div>
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded text-xs font-bold uppercase tracking-wide border"
                                    [ngClass]="{
                                    'bg-green-50 text-green-700 border-green-200': balanceAmount() <= 0 && grandTotal() > 0,
                                    'bg-amber-50 text-amber-700 border-amber-200': balanceAmount() > 0 && paidAmount() > 0,
                                    'bg-red-50 text-red-700 border-red-200': paidAmount() <= 0 && grandTotal() > 0,
                                    'bg-slate-50 text-slate-600 border-slate-200': grandTotal() === 0
                                }">
                                    {{ balanceAmount() <= 0 && grandTotal()> 0 ? 'Paid' : (paidAmount() > 0 ? 'Partial'
                                        :
                                        'Unpaid') }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Advance Amount Mode (Single Input) -->
                    <div class="p-4 space-y-4" *ngIf="!isInstallmentMode()">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Advance Paid
                                (₹)</label>
                            <input type="number" [ngModel]="advanceAmount()" (ngModelChange)="advanceAmount.set($event)"
                                placeholder="0.00"
                                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-900 font-bold outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                        </div>

                        <div *ngIf="advanceAmount() <= 0">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Payment
                                Status</label>
                            <select [ngModel]="simpleModeStatus()" (ngModelChange)="simpleModeStatus.set($event)"
                                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm outline-none focus:border-primary-500">
                                <option value="Pending">Pending</option>
                                <option value="Paid">Fully Paid</option>
                                <option value="Partially Paid">Partially Paid</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-100">
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Balance Due</div>
                                <div class="text-base font-bold text-slate-900">₹{{ balanceAmount() | number:'1.2-2' }}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Status</div>
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded text-xs font-bold uppercase tracking-wide border"
                                    [ngClass]="{
                                    'bg-green-50 text-green-700 border-green-200': balanceAmount() <= 0 && grandTotal() > 0,
                                    'bg-amber-50 text-amber-700 border-amber-200': balanceAmount() > 0 && paidAmount() > 0,
                                    'bg-red-50 text-red-700 border-red-200': paidAmount() <= 0 && grandTotal() > 0,
                                    'bg-slate-50 text-slate-600 border-slate-200': grandTotal() === 0
                                }">
                                    {{ balanceAmount() <= 0 && grandTotal()> 0 ? 'Paid' : (paidAmount() > 0 ? 'Partial'
                                        :
                                        'Unpaid') }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50/50 border-t border-slate-200">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" [(ngModel)]="showPaymentOnPdf"
                            class="w-4 h-4 rounded text-primary-600 border-slate-300">
                        <span
                            class="text-xs font-semibold text-slate-600 group-hover:text-primary-600 transition-colors">Show
                            Payment Details on PDF</span>
                    </label>
                </div>
            </div>

        </div>
    </div>

    <!-- Custom Name Edit Modal -->
    @if (editNameState().isOpen) {
    <div
        class="fixed inset-0 bg-slate-900/50 z-[200] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden" (click)="$event.stopPropagation()">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-display font-bold text-lg text-slate-900">Customize Product Name</h3>
                <p class="text-xs text-slate-500 mt-1">Press Enter to save, Escape to cancel</p>
            </div>
            <div class="p-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Item Name</label>
                </div>
                <input #nameInput type="text" [ngModel]="editNameState().name"
                    (ngModelChange)="updateCustomName($event)" (keydown.enter)="saveCustomName()"
                    (keydown.escape)="closeNameEdit()"
                    class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-900 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
                <button (click)="closeNameEdit()"
                    class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wide rounded hover:bg-slate-50 transition-colors">
                    Cancel
                </button>
                <button (click)="saveCustomName()"
                    class="px-4 py-2 bg-primary-600 text-white text-xs font-bold uppercase tracking-wide rounded hover:bg-primary-700 transition-colors shadow-sm">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    }

    <!-- View Modal (Preview) -->
    @if (selectedInvoice(); as invoice) {
    <div class="fixed inset-0 bg-slate-900/50 z-[100] flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in backdrop-blur-sm no-print"
        (click)="closeView()">
        <div class="bg-white w-full h-full md:h-[90vh] md:max-w-6xl md:rounded-lg shadow-xl flex flex-col overflow-hidden"
            (click)="$event.stopPropagation()">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="font-display font-bold text-lg text-slate-900">
                        {{ 'Invoice Details' }}
                    </h3>
                    <p class="text-xs text-slate-500 font-mono" *ngIf="invoice.id">INV-{{
                        getInvoiceNumberDate(invoice.date)
                        }}-{{ invoice.id }}</p>
                    <p class="text-xs text-primary-600 font-bold uppercase tracking-wider" *ngIf="!invoice.id">Draft
                        Preview
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Preview Button -->
                    <button (click)="openPdfPreview(invoice)"
                        class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-slate-200 text-slate-700 text-xs font-semibold rounded hover:bg-slate-50 transition-colors">
                        @if (isLoadingPdf()) {
                        <span
                            class="animate-spin h-3 w-3 border-2 border-slate-400 border-t-transparent rounded-full"></span>
                        } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-3.5 h-3.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z" />
                        </svg>
                        }
                        PDF Preview
                    </button>

                    <!-- Close Button -->
                    <button (click)="closeView()" class="p-1 text-slate-400 hover:text-slate-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-hidden relative bg-white">
                <!-- Details Mode -->
                <div class="p-6 overflow-y-auto h-full">
                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div>
                            <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-2">Billed To</h4>
                            <div class="text-base font-bold text-slate-900">{{ invoice.client?.name }}</div>
                            <div class="text-sm text-slate-600 mt-1">{{ invoice.client?.address }}</div>
                            <div class="text-sm text-slate-600">{{ invoice.client?.phone }}</div>
                        </div>
                        <div class="text-right">
                            <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-2">Invoice Info
                            </h4>
                            <div class="text-sm text-slate-600"><span class="font-medium text-slate-900">Date:</span> {{
                                invoice.date | date:'longDate' }}</div>
                            <div class="text-sm text-slate-600"><span class="font-medium text-slate-900">Status:</span>
                                <span class="font-bold ml-1" [ngClass]="{
                                    'text-green-600': invoice.paymentStatus === 'Paid',
                                    'text-amber-600': invoice.paymentStatus === 'Partially Paid',
                                    'text-red-600': invoice.paymentStatus === 'Pending'
                                }">{{ invoice.paymentStatus }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse mb-8 min-w-[600px]">
                            <thead>
                                <tr
                                    class="bg-slate-50 border-y border-slate-200 text-[10px] font-bold text-slate-500 uppercase tracking-wide">
                                    @for (col of parsedCustomColumns(); track col.name) {
                                    <th class="px-4 py-2" [class.text-center]="col.id === 'quantity'"
                                        [class.text-right]="col.id === 'price' || col.id === 'total' || (col.isBuiltIn === false && col.type !== 'text')"
                                        [class.text-left]="col.id === 'product' || (col.isBuiltIn === false && col.type === 'text')">
                                        {{ col.name || (parsedColumnLabels()[col.id] || col.id) }}
                                    </th>
                                    }
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                @for (item of invoice.items; track item.id) {
                                <tr>
                                    @for (col of parsedCustomColumns(); track col.name) {
                                    <td class="px-4 py-1.5 text-sm" [class.text-center]="col.id === 'quantity'"
                                        [class.text-right]="col.id === 'price' || col.id === 'total' || (col.isBuiltIn === false && col.type !== 'text')"
                                        [class.text-left]="col.id === 'product' || (col.isBuiltIn === false && col.type === 'text')"
                                        [class.text-slate-900]="col.id === 'product' || col.id === 'total'"
                                        [class.text-slate-600]="col.id !== 'product' && col.id !== 'total'"
                                        [class.font-bold]="col.id === 'total'">

                                        <ng-container [ngSwitch]="col.id">
                                            <div *ngSwitchCase="'product'">
                                                {{ item.productName || item.product?.name }}
                                            </div>
                                            <div *ngSwitchCase="'quantity'">{{ item.quantity }}</div>
                                            <div *ngSwitchCase="'price'">₹{{ item.price | number:'1.2-2' }}</div>
                                            <div *ngSwitchCase="'total'">₹{{ (item.price * item.quantity) |
                                                number:'1.2-2'
                                                }}</div>

                                            <div *ngSwitchDefault>
                                                @if (col.type === 'number' || col.type === 'calculated') {
                                                {{ col.isCurrency ? '₹' : '' }}{{ getCustomValue(item, col) |
                                                number:'1.2-2'
                                                }}
                                                } @else {
                                                {{ getCustomValue(item, col) }}
                                                }
                                            </div>
                                        </ng-container>
                                    </td>
                                    }
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-end">
                        <div class="w-1/2 md:w-1/3 bg-slate-50 p-4 rounded border border-slate-100">
                            <div class="flex justify-between items-center mb-1 text-sm text-slate-500">
                                <span>Subtotal</span>
                                <span>₹{{ invoice.subTotal | number:'1.2-2' }}</span>
                            </div>
                            @if (invoice.discountAmount > 0) {
                            <div class="flex justify-between items-center mb-1 text-sm text-red-500">
                                <span>Discount</span>
                                <span>- ₹{{ invoice.discountAmount | number:'1.2-2' }}</span>
                            </div>
                            }
                            @if (invoice.gstEnabled) {
                            <div class="flex justify-between items-center mb-2 text-sm text-slate-500">
                                <span>GST ({{ invoice.gstRate }})</span>
                                <span>₹{{ invoice.taxTotal | number:'1.2-2' }}</span>
                            </div>
                            }
                            <div
                                class="flex justify-between items-center pt-2 border-t border-slate-200 text-base font-bold text-slate-900">
                                <span>Total</span>
                                <span>₹{{ invoice.total | number:'1.2-2' }}</span>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-100 space-y-2"
                                *ngIf="invoice.showPaymentDetails && invoice.paidAmount > 0">
                                <div class="flex justify-between items-center text-xs text-green-600 font-medium">
                                    <span>Advanced Paid</span>
                                    <span>₹{{ invoice.paidAmount | number:'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs text-amber-600 font-bold">
                                    <span>Remaining Balance</span>
                                    <span>₹{{ (invoice.total - invoice.paidAmount) | number:'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</ion-content>