<ion-header class="ion-no-border">
    <ion-toolbar color="primary">
        <ion-buttons slot="start">
            <ion-menu-button></ion-menu-button>
        </ion-buttons>
        <ion-title class="font-display font-medium">Settings</ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="saveSettings()" [disabled]="saving()">
                <ion-spinner *ngIf="saving()" name="crescent"></ion-spinner>
                <ion-icon name="checkmark-done-outline" *ngIf="successMessage() && !saving()"></ion-icon>
                <span *ngIf="!successMessage() && !saving()">Save</span>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
    <ion-toolbar color="light" class="border-b border-slate-200">
        <ion-segment [value]="activeTab()" (ionChange)="activeTab.set($event.detail.value! + '')" scrollable mode="md">
            <ion-segment-button value="profile">
                <ion-label>Profile</ion-label>
            </ion-segment-button>
            <ion-segment-button value="display">
                <ion-label>Display</ion-label>
            </ion-segment-button>
            <ion-segment-button value="layout">
                <ion-label>Prefs</ion-label>
            </ion-segment-button>
            <ion-segment-button value="table">
                <ion-label>Table</ion-label>
            </ion-segment-button>
        </ion-segment>
    </ion-toolbar>
</ion-header>

<ion-content class="bg-slate-50">
    <div class="p-4 space-y-4 max-w-md mx-auto pb-20">

        <!-- PROFILE TAB -->
        <div *ngIf="activeTab() === 'profile'" class="space-y-4 animate-fade-in">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-4">Identity</h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Company Registered Name</label>
                        <input type="text" [(ngModel)]="settings.companyName"
                            class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm font-semibold focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Proprietor / Signatory</label>
                        <input type="text" [(ngModel)]="settings.companyOwner"
                            class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm font-semibold focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
            </div>

            <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl">
                <h3 class="text-xs font-bold text-indigo-800 uppercase tracking-wide mb-3">Branding Preference</h3>
                <div class="space-y-2">
                    <div *ngFor="let type of ['company','owner']"
                        (click)="settings.businessProfileConfig.nameDisplayType = type"
                        class="flex items-center justify-between px-3 py-3 bg-white border rounded-lg cursor-pointer transition-all"
                        [class.border-indigo-400]="settings.businessProfileConfig.nameDisplayType === type"
                        [class.ring-1]="settings.businessProfileConfig.nameDisplayType === type"
                        [class.ring-indigo-400]="settings.businessProfileConfig.nameDisplayType === type"
                        [class.border-transparent]="settings.businessProfileConfig.nameDisplayType !== type">
                        <span class="text-xs font-bold uppercase tracking-wide"
                            [class.text-indigo-700]="settings.businessProfileConfig.nameDisplayType === type"
                            [class.text-slate-500]="settings.businessProfileConfig.nameDisplayType !== type">
                            {{ type === 'company' ? 'Show Company Name' : 'Show Owner Name' }}
                        </span>
                        <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center"
                            [class.border-indigo-500]="settings.businessProfileConfig.nameDisplayType === type"
                            [class.border-slate-300]="settings.businessProfileConfig.nameDisplayType !== type">
                            <div *ngIf="settings.businessProfileConfig.nameDisplayType === type"
                                class="w-2 h-2 rounded-full bg-indigo-500"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISPLAY TAB (Business Fields) -->
        <div *ngIf="activeTab() === 'display'" class="space-y-4 animate-fade-in">
            <div class="flex justify-between items-center px-1">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wide">Field Arrangement</h3>
                <button (click)="addBusinessCustomField()"
                    class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2.5 py-1 rounded border border-indigo-100 uppercase tracking-wide">
                    + Add Detail
                </button>
            </div>

            <ion-list lines="none" class="bg-transparent p-0 m-0 space-y-2">
                <ion-reorder-group [disabled]="false" (ionItemReorder)="doReorderFields($event)">
                    <div *ngFor="let field of settings.businessProfileConfig.displayFields; let i = index"
                        class="bg-white border border-slate-200 rounded-xl mb-2 overflow-hidden shadow-sm">

                        <div class="flex items-center pl-3 pr-2 py-2 bg-slate-50/50 border-b border-slate-100">
                            <ion-reorder slot="start" class="text-slate-400 mr-2 opacity-50"></ion-reorder>
                            <div class="flex-1">
                                <input *ngIf="!field.isBuiltIn" type="text" [(ngModel)]="field.key"
                                    class="bg-transparent border-none text-[10px] font-bold text-slate-800 p-0 focus:ring-0 uppercase tracking-wide w-full"
                                    placeholder="LABEL...">
                                <span *ngIf="field.isBuiltIn"
                                    class="text-[10px] font-bold text-slate-800 uppercase tracking-wide">{{ field.key
                                    }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <ion-toggle [(ngModel)]="field.show" mode="ios" class="scale-75"></ion-toggle>
                                <button *ngIf="!field.isBuiltIn" (click)="removeBusinessCustomField(i)"
                                    class="text-slate-300 hover:text-red-500 p-1">
                                    <ion-icon name="trash-outline" class="text-base"></ion-icon>
                                </button>
                            </div>
                        </div>

                        <div class="p-3">
                            <textarea *ngIf="field.type === 'textarea'" [(ngModel)]="settings.companyAddress" rows="2"
                                class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-medium focus:bg-white focus:border-indigo-500 outline-none resize-none placeholder-slate-400"
                                placeholder="Enter address..."></textarea>

                            <input *ngIf="field.type === 'text' && field.id === 'phone'" type="tel"
                                [(ngModel)]="settings.companyPhone"
                                class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-medium focus:bg-white focus:border-indigo-500 outline-none placeholder-slate-400"
                                placeholder="Phone number...">

                            <input *ngIf="field.type === 'text' && field.id === 'gst'" type="text"
                                [(ngModel)]="settings.gstNumber"
                                class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-medium focus:bg-white focus:border-indigo-500 outline-none placeholder-slate-400"
                                placeholder="GSTIN...">

                            <input *ngIf="!field.isBuiltIn" type="text" [(ngModel)]="field.value"
                                class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-medium focus:bg-white focus:border-indigo-500 outline-none placeholder-slate-400"
                                placeholder="Enter value...">
                        </div>
                    </div>
                </ion-reorder-group>
            </ion-list>
        </div>

        <!-- PREFERENCES TAB -->
        <div *ngIf="activeTab() === 'layout'" class="space-y-4 animate-fade-in">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-4">Features</h3>

                <ion-item lines="none" class="bg-slate-50 rounded-lg mb-2 border border-slate-200/50">
                    <ion-label>
                        <h3 class="text-xs font-bold text-slate-800 uppercase">Taxation (GST)</h3>
                        <p class="text-[10px] text-slate-400">Enable global tax calculation</p>
                    </ion-label>
                    <ion-toggle slot="end" [(ngModel)]="settings.isGstEnabled" mode="ios"></ion-toggle>
                </ion-item>

                <div *ngIf="settings.isGstEnabled" class="ml-4 pl-4 border-l-2 border-slate-200 mb-4 animate-fade-in">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Default GST Rate</label>
                    <input type="text" [(ngModel)]="settings.gstRate"
                        class="w-24 bg-white border border-slate-200 rounded px-2 py-1 text-sm font-bold text-slate-700">
                </div>

                <ion-item lines="none" class="bg-slate-50 rounded-lg border border-slate-200/50">
                    <ion-label>
                        <h3 class="text-xs font-bold text-slate-800 uppercase">Discount System</h3>
                        <p class="text-[10px] text-slate-400">Enable line-item discounts</p>
                    </ion-label>
                    <ion-toggle slot="end" [(ngModel)]="settings.isDiscountEnabled" mode="ios"></ion-toggle>
                </ion-item>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wide">Terms & Conditions</h3>
                    <ion-toggle [(ngModel)]="settings.showTerms" mode="ios" class="scale-75"></ion-toggle>
                </div>
                <textarea [disabled]="!settings.showTerms" [(ngModel)]="settings.termsAndConditions" rows="6"
                    class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-xs font-medium focus:bg-white focus:border-indigo-500 text-slate-600 disabled:opacity-50 resize-none"
                    placeholder="Enter terms & conditions to show on footer..."></textarea>
            </div>
        </div>

        <!-- TABLE SETUP TAB -->
        <div *ngIf="activeTab() === 'table'" class="space-y-4 animate-fade-in">
            <div class="bg-blue-50 border border-blue-100 p-3 rounded-xl flex items-start gap-3">
                <ion-icon name="information-circle-outline" class="text-blue-500 mt-0.5 text-lg"></ion-icon>
                <div>
                    <h4 class="text-xs font-bold text-blue-800 uppercase">Column Control</h4>
                    <p class="text-[10px] text-blue-600 leading-tight mt-0.5">Drag to reorder columns. Use "Calculated"
                        for formulas.</p>
                </div>
            </div>

            <div class="flex justify-end mb-2">
                <button (click)="addCustomColumn()"
                    class="text-[10px] font-bold text-indigo-600 bg-white shadow-sm border border-indigo-100 px-3 py-1.5 rounded-full uppercase tracking-wide">
                    + Add Column
                </button>
            </div>

            <ion-list lines="none" class="bg-transparent p-0 m-0 space-y-3">
                <ion-reorder-group [disabled]="false" (ionItemReorder)="doReorderColumns($event)">
                    <div *ngFor="let col of customColumns; let i = index"
                        class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm relative group"
                        [class.border-l-4]="col.isBuiltIn" [class.border-l-indigo-500]="col.isBuiltIn"
                        [class.pl-1]="col.isBuiltIn">

                        <!-- Header with Reorder & Delete -->
                        <div class="flex items-center justify-between p-2 bg-slate-50/80 border-b border-slate-100">
                            <div class="flex items-center gap-2">
                                <ion-reorder class="text-slate-400 opacity-50"></ion-reorder>
                                <span class="text-[9px] font-bold uppercase tracking-wide px-1.5 py-0.5 rounded border"
                                    [class.bg-indigo-50]="col.isBuiltIn" [class.text-indigo-600]="col.isBuiltIn"
                                    [class.border-indigo-100]="col.isBuiltIn" [class.bg-slate-100]="!col.isBuiltIn"
                                    [class.text-slate-500]="!col.isBuiltIn" [class.border-slate-200]="!col.isBuiltIn">
                                    {{ col.isBuiltIn ? (col.id === 'total' ? 'System' : 'Core') : 'Custom' }}
                                </span>
                            </div>
                            <button *ngIf="!col.isBuiltIn" (click)="removeCustomColumn(i)"
                                class="text-slate-300 hover:text-red-500 p-1">
                                <ion-icon name="close-outline"></ion-icon>
                            </button>
                        </div>

                        <!-- Content -->
                        <div class="p-3 grid grid-cols-2 gap-3">
                            <!-- Label/Name -->
                            <div class="col-span-2">
                                <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1 tracking-wide">
                                    {{ col.isBuiltIn ? 'Display Label' : 'Column Name' }}
                                </label>
                                <input *ngIf="col.isBuiltIn" type="text" [(ngModel)]="columnLabels[col.id]"
                                    class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-bold text-slate-800 uppercase">
                                <input *ngIf="!col.isBuiltIn" type="text" [(ngModel)]="col.name"
                                    class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-xs font-bold text-slate-800 uppercase"
                                    placeholder="COLUMN NAME">
                            </div>

                            <!-- Custom Config -->
                            <ng-container *ngIf="!col.isBuiltIn">
                                <div>
                                    <label
                                        class="block text-[9px] font-bold text-slate-400 uppercase mb-1 tracking-wide">Type</label>
                                    <ng-select [items]="columnTypes" bindLabel="label" bindValue="value"
                                        [(ngModel)]="col.type" [clearable]="false" [searchable]="false"
                                        class="text-xs"></ng-select>
                                </div>
                                <div class="flex items-center mt-4">
                                    <ion-checkbox [(ngModel)]="col.isCurrency"
                                        class="checkbox-xs font-bold text-[10px] text-slate-600 uppercase">
                                        Currency (â‚¹)
                                    </ion-checkbox>
                                </div>

                                <!-- Formula -->
                                <div *ngIf="col.type === 'calculated'"
                                    class="col-span-2 bg-indigo-50/50 p-2 rounded border border-indigo-100">
                                    <label
                                        class="block text-[9px] font-bold text-indigo-800 uppercase mb-1 tracking-wide flex justify-between">
                                        <span>Formula expression</span>
                                        <span class="text-indigo-400">use: price, qty</span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" [(ngModel)]="col.formula"
                                            class="w-full bg-white border border-indigo-200 rounded pl-2 pr-8 py-1.5 text-xs font-mono font-bold text-indigo-900 shadow-sm focus:border-indigo-500 outline-none"
                                            placeholder="price * qty">
                                        <span
                                            class="absolute right-2 top-1.5 text-indigo-300 font-serif italic text-xs">fx</span>
                                    </div>
                                </div>
                            </ng-container>

                            <!-- Built-in Info -->
                            <div *ngIf="col.isBuiltIn"
                                class="col-span-2 bg-slate-50 py-1.5 px-2 rounded border border-slate-100">
                                <p class="text-[9px] font-medium text-slate-500">
                                    System Behavior:
                                    <span class="font-bold text-slate-700">
                                        {{ col.id === 'product' ? 'Product Description' : col.id === 'quantity' ? 'Item
                                        Quantity' : col.id === 'price' ? 'Unit Price' : 'Row Total (Price x Qty)' }}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </ion-reorder-group>
            </ion-list>
        </div>

    </div>
</ion-content>